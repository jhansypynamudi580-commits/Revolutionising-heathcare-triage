<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Patient Triage | AI Healthcare</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --primary: #58a6ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --font: "DM Sans", system-ui, sans-serif;
      --font-mono: "JetBrains Mono", monospace;
      --radius: 12px;
      --radius-sm: 8px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); font-size: 16px; line-height: 1.5; min-height: 100vh; }
    .app { max-width: 1100px; margin: 0 auto; padding: 1.5rem; min-height: 100vh; display: flex; flex-direction: column; }
    .header { margin-bottom: 1.5rem; }
    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo-icon { font-size: 1.75rem; color: var(--primary); }
    .header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
    .tagline { margin: 0.25rem 0 0 2.5rem; color: var(--text-muted); font-size: 0.9rem; }
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
    .tab { background: transparent; border: none; color: var(--text-muted); padding: 0.5rem 1rem; border-radius: var(--radius-sm); font-family: var(--font); font-size: 0.95rem; cursor: pointer; transition: color 0.2s, background 0.2s; }
    .tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .tab.active { color: var(--primary); background: rgba(88,166,255,0.12); }
    .panel { display: none; flex: 1; }
    .panel.active { display: block; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1rem; }
    .card h2 { margin: 0 0 1rem; font-size: 1.2rem; font-weight: 600; }
    .card h3 { margin: 0 0 0.75rem; font-size: 1rem; font-weight: 600; }
    .hint { color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem; }
    .form-grid label.full { grid-column: 1 / -1; }
    label { display: flex; flex-direction: column; gap: 0.35rem; font-size: 0.9rem; color: var(--text-muted); }
    label input, label select, label textarea { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-family: var(--font); font-size: 0.95rem; }
    label input:focus, label select:focus, label textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(88,166,255,0.2); }
    textarea { resize: vertical; min-height: 60px; }
    .btn { padding: 0.6rem 1.25rem; border-radius: var(--radius-sm); font-family: var(--font); font-size: 0.95rem; font-weight: 500; cursor: pointer; border: none; transition: background 0.2s, color 0.2s; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #79b8ff; }
    .btn-sm { background: var(--surface); color: var(--text-muted); border: 1px solid var(--border); padding: 0.35rem 0.75rem; font-size: 0.85rem; margin-left: 0.5rem; }
    .btn-sm:hover { color: var(--text); border-color: var(--text-muted); }
    .result-card { margin-top: 1rem; }
    .result-card.hidden, .result-card-inner.hidden { display: none !important; }
    .result-card-inner { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
    .risk-badge { display: inline-block; padding: 0.35rem 0.75rem; border-radius: 999px; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .risk-badge.low { background: rgba(63,185,80,0.2); color: var(--success); }
    .risk-badge.medium { background: rgba(210,153,34,0.2); color: var(--warning); }
    .risk-badge.high { background: rgba(248,81,73,0.2); color: var(--danger); }
    .dept-badge { display: inline-block; padding: 0.3rem 0.6rem; background: rgba(88,166,255,0.15); color: var(--primary); border-radius: var(--radius-sm); font-size: 0.9rem; margin-bottom: 0.5rem; }
    .factors-list { list-style: none; padding: 0; margin: 0.5rem 0 0; }
    .factors-list li { padding: 0.35rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; display: flex; justify-content: space-between; gap: 1rem; }
    .factors-list li:last-child { border-bottom: none; }
    .factor-impact.high { color: var(--danger); }
    .factor-impact.medium { color: var(--warning); }
    .factor-impact.low { color: var(--success); }
    #doc-input { margin-bottom: 1rem; color: var(--text); }
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    @media (max-width: 700px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
    .stat-card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; text-align: center; }
    .stat-value { display: block; font-size: 1.75rem; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--text); }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); }
    .stat-card.risk-low .stat-value { color: var(--success); }
    .stat-card.risk-medium .stat-value { color: var(--warning); }
    .stat-card.risk-high .stat-value { color: var(--danger); }
    .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
    @media (max-width: 700px) { .charts-row { grid-template-columns: 1fr; } }
    .chart-card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; }
    .chart-bar { display: flex; flex-direction: column; gap: 0.5rem; }
    .bar-row { display: flex; align-items: center; gap: 0.75rem; }
    .bar-label { min-width: 100px; font-size: 0.85rem; color: var(--text-muted); }
    .bar-track { flex: 1; height: 24px; background: var(--surface); border-radius: 4px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
    .bar-value { font-family: var(--font-mono); font-size: 0.85rem; min-width: 2.5rem; text-align: right; }
    .table-wrap { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .data-table th, .data-table td { padding: 0.6rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
    .data-table th { color: var(--text-muted); font-weight: 500; }
    .data-table tbody tr:hover { background: rgba(255,255,255,0.03); }
    .footer { margin-top: auto; padding-top: 1.5rem; font-size: 0.8rem; color: var(--text-muted); border-top: 1px solid var(--border); }
    .loading { color: var(--text-muted); font-style: italic; }
    .error { color: var(--danger); margin-top: 0.5rem; }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo">
        <span class="logo-icon">◉</span>
        <h1>Smart Patient Triage</h1>
      </div>
      <p class="tagline">AI-driven risk classification & department recommendation — HTML-only demo</p>
    </header>

    <nav class="tabs">
      <button type="button" class="tab active" data-tab="triage">Patient Triage</button>
      <button type="button" class="tab" data-tab="document">Upload EHR/EMR</button>
      <button type="button" class="tab" data-tab="dashboard">Dashboard</button>
    </nav>

    <main class="main">
      <section id="panel-triage" class="panel active">
        <form id="triage-form" class="card form-card">
          <h2>Patient Input</h2>
          <div class="form-grid">
            <label>Age <input type="number" name="age" min="1" max="120" value="45" required /></label>
            <label>Gender
              <select name="gender">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </label>
            <label class="full">Symptoms <textarea name="symptoms" rows="2" placeholder="e.g. chest pain, shortness of breath, dizziness">chest pain, dizziness</textarea></label>
            <label>Blood Pressure <input type="text" name="blood_pressure" placeholder="120/80" value="120/80" /></label>
            <label>Heart Rate (bpm) <input type="number" name="heart_rate" min="30" max="200" value="72" /></label>
            <label>Temperature (°C) <input type="number" name="temperature" step="0.1" min="35" max="42" value="36.6" /></label>
            <label class="full">Pre-existing conditions <input type="text" name="pre_existing_conditions" placeholder="e.g. Hypertension, Diabetes" /></label>
          </div>
          <button type="submit" class="btn btn-primary">Run Triage</button>
        </form>
        <div id="triage-result" class="card result-card hidden">
          <h2>Triage Result</h2>
          <div id="triage-result-body"></div>
        </div>
      </section>

      <section id="panel-document" class="panel">
        <div class="card form-card">
          <h2>Upload EHR / EMR Document</h2>
          <p class="hint">Upload a <strong>.txt</strong> file with patient metadata (Age, BP, Symptoms, etc.). Text is parsed in the browser.</p>
          <form id="document-form">
            <input type="file" name="document" accept=".txt" id="doc-input" />
            <button type="submit" class="btn btn-primary">Analyze Document</button>
          </form>
          <div id="document-result" class="result-card-inner hidden"></div>
        </div>
      </section>

      <section id="panel-dashboard" class="panel">
        <div class="card dashboard-card">
          <h2>Risk & Department Overview</h2>
          <p class="hint">Synthetic patient data generated in the browser. <button type="button" class="btn btn-sm" id="refresh-dashboard">Refresh</button></p>
          <div class="dashboard-grid">
            <div class="stat-card">
              <span class="stat-value" id="stat-total">—</span>
              <span class="stat-label">Total Patients</span>
            </div>
            <div class="stat-card risk-low">
              <span class="stat-value" id="stat-low">—</span>
              <span class="stat-label">Low Risk</span>
            </div>
            <div class="stat-card risk-medium">
              <span class="stat-value" id="stat-medium">—</span>
              <span class="stat-label">Medium Risk</span>
            </div>
            <div class="stat-card risk-high">
              <span class="stat-value" id="stat-high">—</span>
              <span class="stat-label">High Risk</span>
            </div>
          </div>
          <div class="charts-row">
            <div class="chart-card">
              <h3>Risk Distribution</h3>
              <div id="chart-risk" class="chart-bar"></div>
            </div>
            <div class="chart-card">
              <h3>Department Distribution</h3>
              <div id="chart-dept" class="chart-bar"></div>
            </div>
          </div>
          <div class="table-wrap">
            <h3>Recent Patients (sample)</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Patient ID</th>
                  <th>Age</th>
                  <th>Gender</th>
                  <th>Symptoms</th>
                  <th>Risk</th>
                  <th>Department</th>
                </tr>
              </thead>
              <tbody id="dashboard-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      AI-Powered Smart Patient Triage — HTML-only prototype. Not for clinical use.
    </footer>
  </div>

  <script>
(function () {
  const DEPARTMENTS = ["General Medicine", "Cardiology", "Emergency", "Neurology"];
  const SYMPTOM_DEPT = {
    cardiology: ["chest pain", "palpitation", "heart", "cardiac", "hypertension", "bp", "blood pressure", "dizziness", "syncope"],
    emergency: ["unconscious", "severe pain", "bleeding", "trauma", "stroke", "breathing", "choking", "overdose", "critical", "emergency"],
    neurology: ["headache", "migraine", "seizure", "numbness", "stroke", "confusion", "vision", "neuro", "paralysis", "tingling"]
  };

  function parseBp(str) {
    if (!str || typeof str !== "string") return [120, 80];
    const parts = str.match(/\d+/g) || [];
    if (parts.length >= 2) return [parseFloat(parts[0]), parseFloat(parts[1])];
    if (parts.length === 1) return [parseFloat(parts[0]), 80];
    return [120, 80];
  }

  function vitalRiskScore(systolic, diastolic, heartRate, temp) {
    const factors = [];
    let score = 0;
    if (systolic > 180 || diastolic > 120) { score += 0.5; factors.push({ factor: "Severe hypertension", impact: "high", value: systolic + "/" + diastolic + " mmHg" }); }
    else if (systolic > 140 || diastolic > 90) { score += 0.2; factors.push({ factor: "Elevated blood pressure", impact: "medium", value: systolic + "/" + diastolic + " mmHg" }); }
    else if (systolic < 90 || diastolic < 60) { score += 0.4; factors.push({ factor: "Low blood pressure", impact: "high", value: systolic + "/" + diastolic + " mmHg" }); }
    if (heartRate > 120 || heartRate < 50) { score += 0.35; factors.push({ factor: "Abnormal heart rate", impact: "high", value: heartRate + " bpm" }); }
    else if (heartRate > 100 || heartRate < 60) { score += 0.15; factors.push({ factor: "Borderline heart rate", impact: "low", value: heartRate + " bpm" }); }
    if (temp > 39 || temp < 35) { score += 0.4; factors.push({ factor: "Critical temperature", impact: "high", value: temp + "°C" }); }
    else if (temp > 38 || temp < 36) { score += 0.2; factors.push({ factor: "Abnormal temperature", impact: "medium", value: temp + "°C" }); }
    return { score: Math.min(score, 1), factors };
  }

  function symptomRiskScore(text) {
    const factors = [];
    let score = 0;
    const high = ["chest pain", "stroke", "unconscious", "severe", "bleeding", "can't breathe", "collapse", "seizure"];
    const med = ["pain", "dizziness", "shortness of breath", "numbness", "confusion", "fever", "vomiting"];
    high.forEach(term => {
      if (text.indexOf(term) !== -1) { score += 0.25; factors.push({ factor: "Symptom: '" + term + "'", impact: "high", value: "present" }); }
    });
    med.forEach(term => {
      if (text.indexOf(term) !== -1 && score < 0.8) { score += 0.1; factors.push({ factor: "Symptom: '" + term + "'", impact: "medium", value: "present" }); }
    });
    return { score: Math.min(score, 1), factors };
  }

  function ageRiskScore(age) {
    if (age >= 80) return 0.2;
    if (age >= 65) return 0.1;
    if (age < 2) return 0.15;
    return 0;
  }

  function recommendDepartment(symptomsText, vitalFactors) {
    const scores = { "General Medicine": 0, "Cardiology": 0, "Emergency": 0, "Neurology": 0 };
    const reasons = [];
    const deptMap = { cardiology: "Cardiology", emergency: "Emergency", neurology: "Neurology" };
    for (const [dept, keywords] of Object.entries(SYMPTOM_DEPT)) {
      const deptName = deptMap[dept];
      keywords.forEach(kw => {
        if (symptomsText.indexOf(kw) !== -1) {
          scores[deptName] = (scores[deptName] || 0) + 1;
          reasons.push("Symptom match for " + deptName + ": '" + kw + "'");
        }
      });
    }
    vitalFactors.forEach(f => {
      if ((f.factor || "").toLowerCase().indexOf("blood pressure") !== -1 || (f.factor || "").toLowerCase().indexOf("heart rate") !== -1) {
        scores.Cardiology = (scores.Cardiology || 0) + 0.5;
        reasons.push("Vitals suggest cardiac evaluation");
      }
    });
    if (Object.values(scores).every(v => v === 0))
      return { department: "General Medicine", confidence: 0.6, reasons: ["No specific department indicators; defaulting to General Medicine"] };
    let best = "General Medicine";
    DEPARTMENTS.forEach(d => { if ((scores[d] || 0) > (scores[best] || 0)) best = d; });
    const conf = Math.min(0.95, 0.5 + 0.15 * (scores[best] || 0));
    return { department: best, confidence: conf, reasons: reasons.slice(0, 5) };
  }

  function classifyAndRecommend(patient) {
    const age = parseInt(patient.age, 10) || 35;
    const symptomsText = (typeof patient.symptoms === "string" ? patient.symptoms : (Array.isArray(patient.symptoms) ? patient.symptoms.join(" ") : "")).toLowerCase();
    const [systolic, diastolic] = parseBp(patient.blood_pressure || "120/80");
    const heartRate = parseFloat(patient.heart_rate, 10) || 72;
    const temp = parseFloat(patient.temperature, 10) || 36.6;
    const preExisting = (patient.pre_existing_conditions || "").toLowerCase();

    const v = vitalRiskScore(systolic, diastolic, heartRate, temp);
    const s = symptomRiskScore(symptomsText);
    const ageScore = ageRiskScore(age);
    const chronicScore = /diabetes|heart|hypertension|copd|kidney/.test(preExisting) ? 0.1 : 0;

    let totalScore = v.score * 0.35 + s.score * 0.45 + ageScore * 0.1 + chronicScore * 0.1;
    totalScore = Math.min(totalScore, 1);

    let riskLevel = "Low", confidence = 0.8;
    if (totalScore >= 0.6) { riskLevel = "High"; confidence = 0.85; }
    else if (totalScore >= 0.3) { riskLevel = "Medium"; }

    const dept = recommendDepartment(symptomsText, v.factors);
    const contributing = v.factors.concat(s.factors);
    if (ageScore > 0) contributing.push({ factor: "Age factor", impact: "medium", value: age + " years" });
    if (chronicScore > 0) contributing.push({ factor: "Pre-existing conditions", impact: "medium", value: "present" });

    return {
      risk_level: riskLevel,
      risk_score: Math.round(totalScore * 1000) / 1000,
      confidence: confidence,
      recommended_department: dept.department,
      department_confidence: Math.round(dept.confidence * 1000) / 1000,
      department_reasons: dept.reasons,
      contributing_factors: contributing.slice(0, 10),
      vitals_used: { systolic_bp: systolic, diastolic_bp: diastolic, heart_rate: heartRate, temperature: temp }
    };
  }

  function parseEhrText(content) {
    const text = content.replace(/\r\n/g, "\n");
    const get = (key, regex) => { const m = text.match(regex); return m ? m[1].trim() : ""; };
    const age = get("Age", /Age\s*[:\-]\s*(\d+)/i);
    const gender = get("Gender", /Gender\s*[:\-]\s*(\w+)/i);
    const bp = get("BP", /Blood\s*Pressure\s*[:\-]\s*([\d\/]+)/i);
    const hr = get("HR", /Heart\s*Rate\s*[:\-]\s*(\d+)/i);
    const temp = get("Temp", /Temperature\s*[:\-]\s*([\d.]+)/i);
    const symptoms = get("Symptoms", /Symptoms\s*[:\-]\s*(.+?)(?=\n\n|\nPre|$)/is);
    const conditions = get("Pre", /Pre[- ]?[Ee]xisting\s*conditions?\s*[:\-]\s*(.+?)(?=\n|$)/i) || get("Pre", /Pre[- ]?[Ee]xisting\s*Conditions?\s*[:\-]\s*(.+?)(?=\n|$)/i);
    return {
      age: age ? parseInt(age, 10) : 35,
      gender: gender || "Male",
      blood_pressure: bp || "120/80",
      heart_rate: hr ? parseInt(hr, 10) : 72,
      temperature: temp ? parseFloat(temp) : 36.6,
      symptoms: symptoms || "",
      pre_existing_conditions: conditions || ""
    };
  }

  function escapeHtml(s) {
    if (s == null) return "";
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  function renderTriageResult(r) {
    const riskClass = (r.risk_level || "").toLowerCase();
    let html = '<div class="risk-badge ' + riskClass + '">' + escapeHtml(r.risk_level) + " Risk</div>";
    html += '<div class="dept-badge">' + escapeHtml(r.recommended_department) + "</div>";
    html += "<p><strong>Risk score:</strong> " + r.risk_score + " &nbsp; <strong>Confidence:</strong> " + (r.confidence * 100).toFixed(1) + "%</p>";
    html += "<p><strong>Department confidence:</strong> " + (r.department_confidence * 100).toFixed(1) + "%</p>";
    if (r.department_reasons && r.department_reasons.length) {
      html += "<p><strong>Department reasons:</strong></p><ul>";
      r.department_reasons.forEach(reason => { html += "<li>" + escapeHtml(reason) + "</li>"; });
      html += "</ul>";
    }
    if (r.contributing_factors && r.contributing_factors.length) {
      html += "<p><strong>Contributing factors (explainability):</strong></p><ul class=\"factors-list\">";
      r.contributing_factors.forEach(f => {
        const impactClass = (f.impact || "").toLowerCase();
        html += "<li><span>" + escapeHtml(f.factor) + "</span> <span class=\"factor-impact " + impactClass + "\">" + escapeHtml(f.value || f.impact || "") + "</span></li>";
      });
      html += "</ul>";
    }
    if (r.vitals_used) {
      html += "<p><strong>Vitals used:</strong> BP " + r.vitals_used.systolic_bp + "/" + r.vitals_used.diastolic_bp + " mmHg, HR " + r.vitals_used.heart_rate + " bpm, Temp " + r.vitals_used.temperature + " °C</p>";
    }
    return html;
  }

  // Tabs
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
      tab.classList.add("active");
      const id = "panel-" + tab.dataset.tab;
      const panel = document.getElementById(id);
      if (panel) panel.classList.add("active");
      if (tab.dataset.tab === "dashboard") loadDashboard();
    });
  });

  // Triage form
  const triageForm = document.getElementById("triage-form");
  const triageResult = document.getElementById("triage-result");
  const triageResultBody = document.getElementById("triage-result-body");
  triageForm.addEventListener("submit", e => {
    e.preventDefault();
    const fd = new FormData(triageForm);
    const payload = {
      age: parseInt(fd.get("age"), 10) || 35,
      gender: fd.get("gender") || "Male",
      symptoms: fd.get("symptoms") || "",
      blood_pressure: fd.get("blood_pressure") || "120/80",
      heart_rate: parseInt(fd.get("heart_rate"), 10) || 72,
      temperature: parseFloat(fd.get("temperature")) || 36.6,
      pre_existing_conditions: fd.get("pre_existing_conditions") || ""
    };
    triageResult.classList.remove("hidden");
    triageResultBody.innerHTML = renderTriageResult(classifyAndRecommend(payload));
  });

  // Document upload (text only in browser)
  const documentForm = document.getElementById("document-form");
  const documentResult = document.getElementById("document-result");
  documentForm.addEventListener("submit", e => {
    e.preventDefault();
    const fileInput = document.getElementById("doc-input");
    if (!fileInput.files.length) {
      documentResult.classList.remove("hidden");
      documentResult.innerHTML = '<span class="error">Please select a .txt file.</span>';
      return;
    }
    const file = fileInput.files[0];
    if (!file.name.toLowerCase().endsWith(".txt")) {
      documentResult.classList.remove("hidden");
      documentResult.innerHTML = '<span class="error">Only .txt files are supported in this HTML-only version.</span>';
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const extracted = parseEhrText(reader.result);
      const result = classifyAndRecommend(extracted);
      result.extracted_patient = extracted;
      documentResult.classList.remove("hidden");
      let html = "<p><strong>Extracted patient data:</strong></p><pre style=\"font-size:0.85rem;overflow:auto;\">" + escapeHtml(JSON.stringify(extracted, null, 2)) + "</pre><hr style=\"margin:1rem 0;border-color:var(--border)\">";
      html += renderTriageResult(result);
      documentResult.innerHTML = html;
    };
    reader.readAsText(file);
  });

  // Synthetic data & dashboard
  const SYMPTOMS_POOL = ["chest pain", "headache", "dizziness", "shortness of breath", "fever", "cough", "nausea", "vomiting", "abdominal pain", "fatigue", "weakness", "numbness", "confusion", "palpitation", "migraine", "seizure", "severe pain", "bleeding", "stroke", "tingling", "back pain", "joint pain", "rash", "sore throat"];
  const CONDITIONS = ["Hypertension", "Diabetes", "COPD", "Asthma", "Heart disease", "Kidney disease", "None", "Thyroid"];
  const GENDERS = ["Male", "Female", "Other"];

  function randomId() {
    return "PT-" + Math.random().toString(36).slice(2, 10).toUpperCase();
  }
  function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
  function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }

  function generatePatient() {
    const n = randInt(1, 4);
    const syms = [];
    for (let i = 0; i < n; i++) syms.push(rand(SYMPTOMS_POOL));
    const symptoms = syms.join(", ");
    const conditions = Math.random() < 0.5 ? rand(CONDITIONS) : "";
    const high = Math.random() < 0.2;
    const age = high ? (Math.random() < 0.5 ? randInt(55, 88) : randInt(1, 4)) : randInt(18, 85);
    const bp = high && Math.random() < 0.5 ? randInt(150, 185) + "/" + randInt(95, 115) : randInt(100, 138) + "/" + randInt(62, 88);
    const hr = high && Math.random() < 0.4 ? (Math.random() < 0.5 ? randInt(110, 138) : randInt(42, 54)) : randInt(60, 95);
    const temp = high && Math.random() < 0.3 ? (36.2 + Math.random() * 3.5).toFixed(1) : (36.2 + Math.random() * 1.1).toFixed(1);
    return {
      Patient_ID: randomId(),
      Age: age,
      Gender: rand(GENDERS),
      Symptoms: symptoms,
      Blood_Pressure: bp,
      Heart_Rate: hr,
      Temperature: parseFloat(temp),
      Pre_Existing_Conditions: conditions
    };
  }

  function getDashboardData(n) {
    n = Math.min(Math.max(1, n), 500);
    const records = [];
    for (let i = 0; i < n; i++) records.push(generatePatient());
    const results = records.map(r => {
      const out = classifyAndRecommend({
        age: r.Age,
        gender: r.Gender,
        symptoms: r.Symptoms,
        blood_pressure: r.Blood_Pressure,
        heart_rate: r.Heart_Rate,
        temperature: r.Temperature,
        pre_existing_conditions: r.Pre_Existing_Conditions || ""
      });
      return { ...r, Risk_Level: out.risk_level, Recommended_Department: out.recommended_department, Risk_Score: out.risk_score, Confidence: out.confidence };
    });
    const riskDist = { Low: 0, Medium: 0, High: 0 };
    const deptDist = {};
    results.forEach(row => {
      riskDist[row.Risk_Level] = (riskDist[row.Risk_Level] || 0) + 1;
      const d = row.Recommended_Department;
      deptDist[d] = (deptDist[d] || 0) + 1;
    });
    return { total_patients: results.length, risk_distribution: riskDist, department_distribution: deptDist, recent_patients: results.slice(0, 50) };
  }

  function loadDashboard() {
    const totalEl = document.getElementById("stat-total");
    const lowEl = document.getElementById("stat-low");
    const mediumEl = document.getElementById("stat-medium");
    const highEl = document.getElementById("stat-high");
    const chartRisk = document.getElementById("chart-risk");
    const chartDept = document.getElementById("chart-dept");
    const tbody = document.getElementById("dashboard-table-body");
    totalEl.textContent = "…";
    lowEl.textContent = "…";
    mediumEl.textContent = "…";
    highEl.textContent = "…";
    chartRisk.innerHTML = "";
    chartDept.innerHTML = "";
    tbody.innerHTML = "<tr><td colspan=\"6\" class=\"loading\">Loading…</td></tr>";

    setTimeout(() => {
      const data = getDashboardData(100);
      const total = data.total_patients;
      const risk = data.risk_distribution;
      const dept = data.department_distribution;
      totalEl.textContent = total;
      lowEl.textContent = risk.Low || 0;
      mediumEl.textContent = risk.Medium || 0;
      highEl.textContent = risk.High || 0;
      const riskColors = { Low: "var(--success)", Medium: "var(--warning)", High: "var(--danger)" };
      ["Low", "Medium", "High"].forEach(level => {
        const val = risk[level] || 0;
        const pct = total ? ((val / total) * 100).toFixed(0) : 0;
        const row = document.createElement("div");
        row.className = "bar-row";
        row.innerHTML = '<span class="bar-label">' + level + '</span><div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + riskColors[level] + '"></div></div><span class="bar-value">' + val + '</span>';
        chartRisk.appendChild(row);
      });
      const deptColors = ["#58a6ff", "#3fb950", "#d29922", "#a371f7"];
      Object.keys(dept).forEach((name, i) => {
        const val = dept[name] || 0;
        const pct = total ? ((val / total) * 100).toFixed(0) : 0;
        const row = document.createElement("div");
        row.className = "bar-row";
        row.innerHTML = '<span class="bar-label">' + escapeHtml(name) + '</span><div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + (deptColors[i % deptColors.length]) + '"></div></div><span class="bar-value">' + val + '</span>';
        chartDept.appendChild(row);
      });
      tbody.innerHTML = "";
      (data.recent_patients || []).forEach(p => {
        const tr = document.createElement("tr");
        const sym = (p.Symptoms || "").slice(0, 40);
        tr.innerHTML = "<td>" + escapeHtml(p.Patient_ID || "") + "</td><td>" + escapeHtml(String(p.Age ?? "")) + "</td><td>" + escapeHtml(p.Gender || "") + "</td><td>" + escapeHtml(sym) + (p.Symptoms && p.Symptoms.length > 40 ? "…" : "") + "</td><td><span class=\"risk-badge " + (p.Risk_Level || "").toLowerCase() + "\">" + escapeHtml(p.Risk_Level || "") + "</span></td><td>" + escapeHtml(p.Recommended_Department || "") + "</td>";
        tbody.appendChild(tr);
      });
    }, 100);
  }

  document.getElementById("refresh-dashboard").addEventListener("click", loadDashboard);
})();
  </script>
</body>
</html>
